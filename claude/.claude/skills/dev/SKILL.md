---
name: dev
description: |
  既存プロジェクトに新機能を追加・実装するためのワークフロー。「○○機能を実装して」「○○を作って」「○○を開発して」「このIssueをやって」等、機能開発を依頼された場合に必ず使用する。GitHub Issueリンクを含むリクエストにも使用する。バグ修正、環境構築、設定変更、ドキュメント作成には使わない。
---

# /dev — フィーチャー開発ワークフロー

バックログアイテムやユーザーストーリーを受け取り、段階的に機能を実装するワークフロー。
各フェーズで成果物（mdファイル）を生成し、ユーザーのレビューを経て次フェーズへ進む。

**役割分担**:
- **Claude**: 調査、分析、比較検討、**技術的判断の自律的な決定**、ドラフト作成、実装
- **ユーザー**: ドメインエキスパートとしてのレビュー、**業務・ドメインに関する判断**の提供

**判断の自律性について** — これは非常に重要:
- **技術的・非機能的な判断**（アーキテクチャ、データ取得方法、ルーティング方式、パフォーマンス最適化、ライブラリ選定等）は **Claude が調査の上で自ら決定する**。ユーザーに聞かない。決定の根拠は成果物に記録する。
- **ドメイン・業務の判断**（ビジネスルール、ユーザーの行動パターン、業界慣行、課題の優先度等）は初期段階で徹底的に調査する。調査しても確信が持てない場合のみ、ユーザーに確認する。
- ユーザーはすべての成果物をレビューできるので、Claude の技術判断に異論があればその時点で指摘できる。だからこそ Claude は遠慮なく判断して先に進むべき。

**スコープ規律** — ユーザーが依頼した機能にのみ集中する:
- **前提条件・依存関係は設計対象に含めない**。たとえば「請求管理」を依頼された場合、認証基盤は前提条件として記載するが、認証の技術選定やアーキテクチャ設計はスコープ外。「今回の機能を実装するために〇〇が前提として必要」と一言触れれば十分。
- **スコープ膨張の兆候**: 「〇〇の前にまず△△が必要」と考え始めたら、△△は依存関係として注記するだけに留め、設計・比較検討はしない。△△が別途必要なら、ユーザーが別の開発タスクとして依頼する。
- RFC の「スコープ外」セクションに前提条件を含めて明示する。

## ワークフロー全体像

| # | フェーズ | 成果物 | ゲート |
|---|---------|--------|--------|
| 0 | インテイク | — | スコープ合意 |
| 1 | RFC | `rfc.md` | 技術アプローチ承認 |
| 2 | PRD | `prd.md` | 要件承認 |
| 3 | ユースケース | `usecases.md` | シナリオ網羅性承認 |
| 4 | UI/UXデザイン | `uiux-design.md` + Storybook | プロトタイプ承認 |
| 5 | DDDモデリング | `ddd-model.md` | ドメインモデル承認 |
| 6 | 技術設計 | `technical-design.md` | 設計承認 |
| 7 | 実装 | ソースコード | コード確認 |
| 8 | テスト | テストコード | テスト通過確認 |
| 9 | セルフレビュー & PR | PR | — |

フェーズのスキップは可能（例: バックエンドのみなら Phase 4 をスキップ）。インテイク時にユーザーと合意する。

## 起動手順

1. ユーザー入力を解析（自然言語 or GitHub Issue URL）
   - GitHub Issue URL → `gh issue view {number}` で取得
2. TodoList にフェーズごとのタスクを作成（進捗の可視化）
3. `docs/dev/{feature-name}/` ディレクトリを作成
4. Phase 0 を開始

`{feature-name}` はユーザーストーリーから導出する短い英語名（例: `search-filters`, `user-favorites`）。フィーチャーブランチ名（`feature/{feature-name}`）とディレクトリ名を揃える。

## レビュープロトコル

このワークフローの中核。すべてのフェーズで同じサイクルを回す。

### 成果物の共通構造

```markdown
# {フェーズ名}: {機能名}

**ステータス**: draft | in-review | approved
**更新日**: YYYY-MM-DD
**イテレーション**: N

---

{本文}

---

## 技術判断ログ

Claude が調査の上で決定した技術的・非機能的な判断を記録する。
ユーザーがレビュー時に異論があれば指摘できるよう、根拠を明記する。

| # | 判断ポイント | 選択肢 | 決定 | 根拠 |
|---|-------------|--------|------|------|
| 1 | {技術的な判断} | A / B / C | {選択} | {なぜこれを選んだか} |

## ドメインに関する確認事項

ドメイン・業務知識について調査しても確信が持てなかった点のみ記載する。
該当がなければ「確認事項なし — 調査で十分な確信を得た」と記載。

1. **{ドメインの疑問点}**
   - 調査結果: {何を調べ、何がわかったか}
   - 想定: {Claude の現時点の想定}
   - 確認したいこと: {ユーザーに判断してほしい具体的な点}

## 変更履歴

- v1: 初回ドラフト
- v2: {フィードバック反映内容}
```

### レビューサイクル

1. Claude が成果物を生成（ステータス: `in-review`）
   - 技術判断は Claude が自律的に決定し「技術判断ログ」に記録
   - ドメインの不明点がある場合のみ「ドメインに関する確認事項」に記載
2. ユーザーに「レビューをお願いします」と伝え、ファイルパスを示す
3. ユーザーがフィードバック（チャット or mdファイルへのインライン注釈）
4. Claude がフィードバックを読み取り、成果物を更新
5. ステータスを `approved` に変更し、次フェーズへ

承認まで通常 1〜3 イテレーション。フィードバックが「LGTM」「OK」「問題なし」相当なら即承認。

## Phase 0: インテイク

**目的**: ユーザーストーリーを正確に理解し、スコープを確定する。ドメイン知識を徹底的に調査する。

1. 入力を解析し、ユーザーストーリーの本質を把握
2. **Explore サブエージェント**で既存コードベースを調査:
   - CLAUDE.md からプロジェクト構成・規約を把握
   - 関連する既存コード・パターンを特定
   - 技術スタックの確認
3. **ドメイン知識の徹底調査**（この段階で可能な限り深く調べる）:
   - プロジェクト内のドメイン関連ドキュメント（ビジネスモデル、仕様書等）を精読
   - 既存コードからドメインルール・ビジネスロジックを読み解く
   - 業界の一般的なパターン・慣行をリサーチ
   - ユーザーが「ドメインエキスパート」である前提で、調査で確信が持てない業務・ドメインの判断のみ質問する
4. 以下をユーザーに要約・確認:
   - ユーザーストーリーの理解（「〜として、〜したい。なぜなら〜」形式）
   - 影響範囲の見込み
   - 適用フェーズの提案（不要フェーズのスキップ確認）
   - ドメインに関して調査しても確信が持てなかった点（ある場合のみ）

## Phase 1: RFC

**目的**: 技術アプローチを提案し、方向性の合意を得る

1. **Explore サブエージェント**で問題空間をリサーチ（既存コード、一般的パターン、トレードオフ）
2. `rfc.md` を生成:
   - 背景と課題
   - 2〜3 の技術アプローチ案と比較表
   - 推奨案と推奨理由
   - リスクと軽減策
   - 前提条件・依存関係
   - スコープ外
3. 技術判断ログ: アプローチ選定理由、トレードオフの判断根拠を記録
4. ドメインに関する確認事項: 調査で確信が持てなかったドメインの判断のみ記載

## Phase 2: PRD

**目的**: 機能要件・非機能要件を明確にする

1. 承認された RFC に基づき `prd.md` を生成:
   - 機能要件（MoSCoW 優先度付き）
   - 非機能要件（パフォーマンス、セキュリティ、アクセシビリティ等）
   - 受け入れ基準（Given-When-Then 形式推奨）
   - 制約事項・前提条件
2. 技術判断ログ: 非機能要件の数値目標、技術的制約の判断根拠を記録
3. ドメインに関する確認事項: ビジネスルールや優先度で不明な点のみ記載

## Phase 3: ユースケース定義

**目的**: すべてのシナリオを網羅的に洗い出す

1. PRD に基づき `usecases.md` を生成:
   - 正常系シナリオ（ハッピーパス）
   - 異常系シナリオ（バリデーションエラー、権限不足、データ不存在等）
   - エッジケース（境界値、同時実行、タイムアウト等）
   - 各シナリオ: アクター、事前条件、手順、事後条件、期待結果
2. 技術判断ログ: テストカバレッジ方針、シナリオ分類の判断根拠を記録
3. ドメインに関する確認事項: ビジネス上のエッジケースで不明な点のみ記載

このフェーズの成果物は Phase 8（テスト）の入力になる。ここで洗い出したシナリオがそのままテストケースの元になるため、網羅性が重要。

## Phase 4: UI/UXデザイン

**目的**: Storybook で動作確認できるプロトタイプを作る

`references/phase-details.md` の「UI/UXデザイン詳細」セクションを参照。

1. `uiux-design.md` を生成:
   - ユーザーフロー図（Mermaid 記法）
   - コンポーネント構成（新規・既存の区別）
   - 画面レイアウト（ASCII ワイヤーフレーム or 説明）
   - インタラクション定義（状態遷移、ローディング、エラー表示）
   - アクセシビリティ考慮事項
2. **Storybook プロトタイプを実装**（`general-purpose` サブエージェントに委任）:
   - UI コンポーネントを作成し、Storybook ストーリーを同梱
   - モックデータで動作する状態にする
   - `npm run storybook` でユーザーが確認できるようにする
3. ユーザーに Storybook での動作確認を依頼
4. 技術判断ログ: コンポーネント分割、状態管理、レスポンシブ対応の判断根拠を記録
5. ドメインに関する確認事項: ユーザー行動パターンやUXの業務的要件で不明な点のみ記載

## Phase 5: DDDモデリング

**目的**: 戦略的 DDD でドメインを整理し、実装の土台を作る

`references/phase-details.md` の「DDDモデリング詳細」セクションを参照。

1. **Explore サブエージェント**で既存コードベースとの整合性を調査
2. 調査結果を基に `ddd-model.md` を生成:
   - ユビキタス言語（用語集）
   - 境界づけられたコンテキストの特定
   - コンテキストマップ（Mermaid 図）
   - ドメインイベントの洗い出し
   - 既存コードベースとの整合性分析
3. 技術判断ログ: コンテキスト境界の技術的判断、集約設計の根拠を記録
4. ドメインに関する確認事項: ドメイン用語の解釈やビジネスルールで不明な点のみ記載

## Phase 6: 技術設計

**目的**: 実装の詳細設計を確定する

Phase 0〜5 のレビューサイクルで蓄積したコンテキストは成果物ファイルに集約済み。
**サブエージェントに成果物パスを渡してドラフト生成を委任**し、メインはレビュー対応に集中する。

1. `general-purpose` サブエージェントに Phase 1〜5 の成果物パスを渡し、`technical-design.md` のドラフト生成を委任:
   - アーキテクチャ図（Mermaid 記法）
   - API 設計（エンドポイント、リクエスト / レスポンス、TypeSpec 定義）
   - データベーススキーマ変更（Drizzle マイグレーション）
   - 主要コンポーネントの責務とインターフェース
   - ファイル構成（新規 / 変更ファイル一覧）
   - 実装順序（依存関係を考慮した段階的計画）
2. ドラフトをレビューし、必要に応じて修正
3. 技術判断ログ: API設計、スキーマ設計、実装順序の判断根拠を記録
4. ドメインに関する確認事項: ビジネスロジックの解釈で不明な点のみ記載

## Phase 7: 実装

**目的**: 技術設計に基づきコードを書く

`technical-design.md` が完成しているため、各実装ステップをサブエージェントに委任できる。
メインは進捗管理と設計乖離の判断に集中する。

1. `technical-design.md` の実装順序に従い、各ステップを `general-purpose` サブエージェントに委任:
   - 依存関係があるステップは前のステップ完了を確認してから委任
   - 独立したステップは並行委任
   - サブエージェントには `technical-design.md` のパス、CLAUDE.md のパス、対象ファイルパスを渡す
2. TodoList を各ステップで更新し進捗を可視化
3. 設計との乖離を発見した場合:
   - 軽微 → 実装を進め、後で design を更新
   - 重大 → ユーザーに相談してから判断

## Phase 8: テスト

**目的**: ユースケースに基づくテストで品質を担保する

1. `usecases.md` のシナリオをテストケースに変換し、`general-purpose` サブエージェントにテスト種別ごとに委任:
   - ユニットテスト（プロジェクトのテストフレームワークに従う）
   - 統合テスト（API エンドポイント等）
   - E2E テスト（主要ユーザーフロー、必要な場合）
2. テストを実行し全パスを確認
3. 失敗時は原因調査 → 修正 → リトライ
4. 結果のサマリーをユーザーに報告

## Phase 9: セルフレビュー & PR

**目的**: 品質チェックを行い、PR を作成する

1. **セルフレビュー**（`general-purpose` サブエージェントに委任）:
   - lint / format 実行（プロジェクト規約に従う）
   - 型チェック
   - 各フェーズの成果物との整合性確認
   - セキュリティ上の懸念がないか確認
2. サブエージェントの報告を確認し、問題があれば修正
3. **PR 作成**:
   - `feature/{feature-name}` ブランチを作成（CLAUDE.md の Git 規約に従う）
   - Conventional Commits でコミット
   - PRD・ユースケース・技術設計を要約した PR 本文を作成
   - `gh pr create` で作成
4. PR リンクをユーザーに共有

## サブエージェント戦略

10フェーズのワークフローはコンテキストウィンドウを圧迫しやすい。
成果物ファイル（md）経由で引き継げるタスクはサブエージェントに委任し、メインコンテキストを保護する。

### 委任マップ

| Phase | 委任タスク | エージェント | メインに残すもの |
|-------|-----------|-------------|----------------|
| 0 | コードベース調査 | `Explore` | 要約結果の受領、ユーザー確認 |
| 1 | 既存実装の深掘り調査 | `Explore` | rfc.md 生成、レビュー対応 |
| 4 | Storybook コンポーネント実装 | `general-purpose` | uiux-design.md 生成、レビュー対応 |
| 5 | コードベースとの整合性分析 | `Explore` | ddd-model.md 生成、レビュー対応 |
| 6 | technical-design.md ドラフト生成 | `general-purpose` | レビュー対応のみ |
| 7 | 各実装ステップ | `general-purpose` | 進捗管理、設計乖離の判断 |
| 8 | テスト種別ごとの作成 | `general-purpose` | テスト結果確認、修正指示 |
| 9 | lint/format/型チェック | `general-purpose` | PR 作成、ユーザー共有 |

### Phase 6 コンテキストリセット

Phase 6 はワークフローの折り返し地点。Phase 0〜5 のレビューサイクルで蓄積した会話コンテキストは成果物ファイルに集約済みなので、サブエージェントに md パスを渡してドラフト生成を委任する。これにより蓄積コンテキストをリセットし、実装フェーズに備える。

### 原則

- メインコンテキストはワークフロー管理・レビューサイクル・意思決定に集中
- サブエージェントの結果は要約のみ受け取る（中間出力はサブエージェント内で完結）
- 同一ファイルを複数エージェントが編集する状況は避ける
- サブエージェントには CLAUDE.md のパス・対象成果物パス・既存パターンの参考ファイルパスを渡す

## 成果物ディレクトリ

```
docs/dev/{feature-name}/
├── rfc.md              # Phase 1
├── prd.md              # Phase 2
├── usecases.md         # Phase 3
├── uiux-design.md      # Phase 4
├── ddd-model.md        # Phase 5
└── technical-design.md # Phase 6
```

これらの成果物はフィーチャーブランチにコミットし、PR のコンテキストとして残す。将来の参照や意思決定の経緯追跡に有用。
